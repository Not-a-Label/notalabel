# CI/CD Setup Guide for Not a Label

## Overview

This guide explains how to set up automated deployments for the Not a Label platform using GitHub Actions.

## üöÄ Quick Start

1. **Run the setup script**:
   ```bash
   ./setup-github-deploy.sh
   ```

2. **Add SSH key to GitHub**:
   - Go to your repository Settings ‚Üí Secrets and variables ‚Üí Actions
   - Add a new secret named `SSH_PRIVATE_KEY`
   - Paste the private key content shown by the setup script

3. **Push to deploy**:
   ```bash
   git add .
   git commit -m "Add CI/CD pipeline"
   git push origin main
   ```

## üìã How It Works

### GitHub Actions Workflow

The deployment pipeline (`deploy.yml`) automatically:

1. **Tests** your code when you push
2. **Builds** the project
3. **Deploys** to the DigitalOcean server
4. **Runs health checks** to verify deployment
5. **Sends notifications** (if configured)

### Deployment Process

1. **Backend Deployment**:
   - Creates backup of current backend
   - Uploads new code
   - Installs dependencies
   - Builds TypeScript
   - Restarts PM2 process

2. **Frontend Deployment**:
   - Creates backup of current frontend
   - Uploads new code
   - Installs dependencies
   - Builds Next.js app
   - Restarts PM2 process

3. **Rollback on Failure**:
   - Automatically keeps 3 recent backups
   - Can manually rollback if needed

## üîß Configuration

### Required GitHub Secrets

1. **SSH_PRIVATE_KEY** (Required)
   - The private SSH key for server access
   - Generated by the setup script

2. **DISCORD_WEBHOOK** (Optional)
   - Discord webhook URL for deployment notifications
   - Format: `https://discord.com/api/webhooks/...`

### Triggering Deployments

Deployments trigger automatically on:
- Push to `main` or `master` branch
- Manual trigger from GitHub Actions tab

### Manual Deployment

You can also trigger deployment manually:

```bash
# From GitHub Actions tab
1. Go to Actions ‚Üí Deploy to DigitalOcean
2. Click "Run workflow"
3. Select branch and click "Run workflow"
```

## üìä Monitoring Deployments

### GitHub Actions

- View deployment status in the Actions tab
- See detailed logs for each step
- Get email notifications on failure

### Server Logs

```bash
# View deployment logs
ssh root@159.89.247.208 'ls -la /var/www/not-a-label/logs/'

# View latest deployment log
ssh root@159.89.247.208 'tail -f /var/www/not-a-label/logs/deploy-*.log'

# Check PM2 status
ssh root@159.89.247.208 'pm2 status'

# View PM2 logs
ssh root@159.89.247.208 'pm2 logs'
```

### Health Checks

The deployment automatically checks:
- Backend API: `http://localhost:4000/api/health`
- Frontend: `http://localhost:3000`
- PM2 process status

## üîÑ Rollback Procedure

If a deployment fails or causes issues:

### Automatic Rollback

The deployment keeps the last 3 backups automatically.

### Manual Rollback

```bash
ssh root@159.89.247.208

# List available backups
ls -la /var/www/not-a-label/backend-backup-*
ls -la /var/www/not-a-label/frontend-backup-*

# Rollback backend
cd /var/www/not-a-label
mv backend backend-failed
mv backend-backup-20250531-123456 backend
cd backend
pm2 restart backend-fixed

# Rollback frontend
cd /var/www/not-a-label
mv frontend frontend-failed
mv frontend-backup-20250531-123456 frontend
cd frontend
pm2 restart not-a-label-frontend
```

## üõ†Ô∏è Troubleshooting

### Deployment Fails

1. **Check GitHub Actions logs**:
   - Click on the failed workflow run
   - Expand the failed step
   - Review error messages

2. **Common Issues**:
   - SSH connection failed ‚Üí Check SSH_PRIVATE_KEY secret
   - Build failed ‚Üí Check for missing dependencies
   - Health check failed ‚Üí Services may need more time to start

### SSH Key Issues

```bash
# Test SSH connection locally
ssh -i ~/.ssh/nal-deploy root@159.89.247.208 'echo "Connection OK"'

# Regenerate key if needed
ssh-keygen -t ed25519 -f ~/.ssh/nal-deploy-new -C "github-deploy@not-a-label" -N ""
```

### PM2 Issues

```bash
# Restart all processes
ssh root@159.89.247.208 'pm2 restart all'

# Check error logs
ssh root@159.89.247.208 'pm2 logs --err'

# Reset PM2 if needed
ssh root@159.89.247.208 'pm2 kill && pm2 resurrect'
```

## üîí Security Best Practices

1. **Never commit secrets** to the repository
2. **Use GitHub Secrets** for sensitive data
3. **Limit deployment access** to specific branches
4. **Monitor deployment logs** for unauthorized access
5. **Rotate SSH keys** periodically

## üìù Advanced Configuration

### Custom Deployment Branches

Edit `.github/workflows/deploy.yml`:

```yaml
on:
  push:
    branches: [ main, staging, production ]
```

### Environment-Specific Deployments

Add environment variables to the workflow:

```yaml
env:
  NODE_ENV: production
  API_URL: https://api.not-a-label.art
```

### Slack Notifications

Replace Discord webhook with Slack:

```yaml
- name: Send Slack notification
  env:
    SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
  run: |
    curl -X POST $SLACK_WEBHOOK \
      -H "Content-Type: application/json" \
      -d '{"text": "Deployment completed successfully!"}'
```

## üéØ Next Steps

1. **Set up staging environment** for testing deployments
2. **Add automated testing** to the pipeline
3. **Configure code quality checks** (ESLint, TypeScript)
4. **Set up database migrations** for schema changes
5. **Add performance monitoring** to track deployment impact

---

## üìû Support

If you encounter issues:

1. Check the troubleshooting section above
2. Review GitHub Actions logs
3. Check server logs and PM2 status
4. Ensure all secrets are correctly configured

The CI/CD pipeline is now ready for automated deployments!